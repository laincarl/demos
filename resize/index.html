<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    #obj{
    height: 50%;
    width: 50%;
    background: blueviolet;
  }
  #resizeDiv {
            width: 60%;
            height: 200px;
            border: 1px solid red;
            margin: 20px;
            background: green;
        }

        button {
            margin: 20px 20px 0;
        }
  </style>
</head>

<body>
  <object data="about:blank" type="" id="obj"></object>
  <button onclick="addListener()">addListener</button>
  <button onclick="removeListener()">removeListener</button>
  <button onclick="resize()">resize</button>
  <div id="resizeDiv"></div>
  <script>
    var resizeDiv = document.getElementById('resizeDiv');
    function resize() {
      resizeDiv.style.width = "200px";
    }
    var listener = function () {
      console.log("resize");
    };
    var listener2 = function () {
      console.log("resize2");
    };
    function addListener() {
      // EleResize.on(resizeDiv, listener);
      addResizeListener(resizeDiv, listener2)
    }
    function removeListener() {
      // EleResize.off(resizeDiv, listener)
      removeResizeListener(resizeDiv, listener2)
    }
  </script>
  <script>
    var obj = document.getElementById('obj')
    // obj.contentDocument.defaultView.addEventListener('resize', function () {
    //   console.log('resize')
    // })
  </script>
  <script>
    /**
   * Created by taozh on 2017/5/6.
   * taozh1982@gmail.com
   */
    var EleResize = {
      _handleResize: function (e) {
        var ele = e.target || e.srcElement;
        var trigger = ele.__resizeTrigger__;
        if (trigger) {
          var handlers = trigger.__z_resizeListeners;
          if (handlers) {
            var size = handlers.length;
            for (var i = 0; i < size; i++) {
              var h = handlers[i];
              var handler = h.handler;
              var context = h.context;
              handler.apply(context, [e]);
            }
          }
        }
      },
      _removeHandler: function (ele, handler, context) {
        var handlers = ele.__z_resizeListeners;
        if (handlers) {
          var size = handlers.length;
          for (var i = 0; i < size; i++) {
            var h = handlers[i];
            if (h.handler === handler && h.context === context) {
              handlers.splice(i, 1);
              return;
            }
          }
        }
      },
      _createResizeTrigger: function (ele) {
        var obj = document.createElement('object');
        obj.setAttribute('style',
          'display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden;opacity: 0; pointer-events: none; z-index: -1;');
        obj.onload = EleResize._handleObjectLoad;
        obj.type = 'text/html';
        ele.appendChild(obj);
        obj.data = 'about:blank';
        return obj;
      },
      _handleObjectLoad: function (evt) {
        this.contentDocument.defaultView.__resizeTrigger__ = this.__resizeElement__;
        this.contentDocument.defaultView.addEventListener('resize', EleResize._handleResize);
      }
    };
    if (document.attachEvent) {//ie9-10
      EleResize.on = function (ele, handler, context) {
        console.log('ie')
        var handlers = ele.__z_resizeListeners;
        if (!handlers) {
          handlers = [];
          ele.__z_resizeListeners = handlers;
          ele.__resizeTrigger__ = ele;
          ele.attachEvent('onresize', EleResize._handleResize);
        }
        handlers.push({
          handler: handler,
          context: context
        });
      };
      EleResize.off = function (ele, handler, context) {
        var handlers = ele.__z_resizeListeners;
        if (handlers) {
          EleResize._removeHandler(ele, handler, context);
          if (handlers.length === 0) {
            ele.detachEvent('onresize', EleResize._handleResize);
            delete ele.__z_resizeListeners;
          }
        }
      }
    } else {
      EleResize.on = function (ele, handler, context) {
        console.log('非ie')
        var handlers = ele.__z_resizeListeners;
        if (!handlers) {
          handlers = [];
          ele.__z_resizeListeners = handlers;

          if (getComputedStyle(ele, null).position === 'static') {
            ele.style.position = 'relative';
          }
          var obj = EleResize._createResizeTrigger(ele);
          ele.__resizeTrigger__ = obj;
          obj.__resizeElement__ = ele;
        }
        handlers.push({
          handler: handler,
          context: context
        });
      };
      EleResize.off = function (ele, handler, context) {
        var handlers = ele.__z_resizeListeners;
        if (handlers) {
          EleResize._removeHandler(ele, handler, context);
          if (handlers.length === 0) {
            var trigger = ele.__resizeTrigger__;
            if (trigger) {
              trigger.contentDocument.defaultView.removeEventListener('resize', EleResize._handleResize);
              // ele.removeChild(trigger);
              // delete ele.__resizeTrigger__;
            }
            delete ele.__z_resizeListeners;
          }
        }
      }
    }
  </script>
  <script>
    /**
   * 添加监听
   * @param {*} ele 
   * @param {*} handler 
   */
    function addResizeListener(ele, handler) {
      // 因为要为目标元素创建一个object子元素，所以先对样式进行处理
      if (getComputedStyle(ele, null).position === 'static') {
        ele.style.position = 'relative';
      }
      const object = ele._ResizeObject_;
      // 已经存在object元素
      if (object) {
        _addHandler(object, handler, ele);
      } else {
        // 不存在时，创建object元素，并添加监听
        const objectElement = _createObjectElement(ele, handler);
        // 必须先定义onload事件，再append,来兼容浏览器

      }
    }
    /**
     * 移除监听
     * @param {*} ele 
     * @param {*} handler 
     */
    function removeResizeListener(ele, handler) {
      // 存在object元素，说明加过监听
      const object = ele._ResizeObject_;
      if (object) {
        _removeHandler(object, handler);
      }
    }
    function _createObjectElement(ele, handler) {
      const objectElement = document.createElement('object');
      objectElement.setAttribute('style', 'display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden;opacity: 0; pointer-events: none; z-index: -1;');
      objectElement.onload = function () {
        _addHandler(objectElement, handler, ele);
      }

      objectElement.type = 'text/html';

      ele.appendChild(objectElement);
      objectElement.data = 'about:blank';

      return objectElement;
    }

    function _addHandler(objectElement, handler, ele) {
      // 将object元素保存在目标元素上
      ele._ResizeObject_ = objectElement;
      objectElement.contentDocument.defaultView.addEventListener('resize', handler);
    }

    function _removeHandler(objectElement, handler) {
      if (objectElement.contentDocument) {
        objectElement.contentDocument.defaultView.removeEventListener('resize', handler);
      }
    }
  </script>
</body>

</html>