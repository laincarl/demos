<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>仿immer, immutable-js</title>
</head>

<body>
  <figure>
    <figcaption>目标：</figcaption>
    <pre>
      <code>       
        const obj = {
          a: 5,
          b: [1, 2]
        }
        const obj2 = produce(obj, (state) => {
          state.a = 6;
        })
        obj !== obj2
        obj.b === obj2.b
      </code>
    </pre>
  </figure>
  <script>

    function isObject(something) {
      return something instanceof Object;
    }
    function isProxy(something) {

    }
    function lazyProxy(object) {
      const proxy = new Proxy(object, {
        get: function (target, propKey, receiver) {
          console.log(`get:${propKey}`, target);
          if (isObject(target[propKey]) && !isProxy(target[propKey])) {
            const copy = { ...target[propKey] };
            lazyProxy(copy)
            return copy
          }
          return target[propKey];
        },
        set: function (target, propKey, value, receiver) {
          console.log(`setting ${propKey}!`);
          return Reflect.set(target, propKey, value, receiver);
        }
      });
      return proxy
    }
    const source = {
      a: 1,
      b: {
        c: 1
      }
    }
    
    function produce(state, fn) {
      const proxy = lazyProxy(source);
      fn(proxy)
      return proxy;
    }
    const result = produce(source, (draft) => {
      draft.a = 5;
    })
    console.log(source, result)
    // console.assert(result !== source, "对象相等");
    // console.assert(result.b === source.b, "子属性不相等");
  </script>
</body>

</html>